# ERROR_CATALOG.md — Каталог ошибок и формат сообщений

## Назначение

Единый стиль ошибок для AnyGate: форматы HTTP-ответов и лог-сообщений, справочник кодов по подсистемам (валидация, рантайм, апстрим, статика, TLS, плагины, политика), маппинг в статусы HTTP и рекомендации оператору.

---

## Стиль и принципы

* Один стабильный **код ошибки** `AG-<ДОМЕН>-<NNNN>`.
* Короткое **message** (человекочитаемо, без секретов), расширенные детали — только в логах.
* Корреляция: `trace_id` во всех сообщениях и в заголовке ответа.
* При `secure_error_log: true` — удаление секретов и сокращение контекстов.
* Никаких стек-трейсов в HTTP; стек — только в логах при `log_all_errors: true`.

---

## Форматы сообщений

### HTTP-ответ клиенту (JSON)

```json
{
  "error": {
    "code": "AG-UPS-2001",
    "message": "Bad gateway: upstream connection failed",
    "status": 502
  },
  "trace": {
    "trace_id": "9f09e6e1c8a44b58",
    "route": "GET /v1/*",
    "action": "proxy"
  }
}
```

* Поле `trace_id` дублируется в заголовке `X-Request-Id`.
* Допполя (`upstream`, `retry`, `policy`) добавляются **без секретов**.

### Лог-событие (JSONL)

```json
{
  "ts": "2025-10-17T13:37:42.123Z",
  "level": "ERROR",
  "code": "AG-UPS-2001",
  "message": "connect failed",
  "component": "proxy",
  "trace_id": "9f09e6e1c8a44b58",
  "route": "GET /v1/*",
  "action": "proxy",
  "upstream": "http://auth:8000",
  "attempt": 1,
  "errno": "ECONNREFUSED",
  "duration_ms": 42
}
```

---

## Домены и диапазоны кодов

* `VLD-1xxx` — валидация конфигурации/DSL (startup/hot-reload).
* `RTE-1yxz` — рантайм HTTP приём/парсинг/лимиты.
* `UPS-2xxx` — апстрим/прокси.
* `TLS-3xxx` — TLS/mTLS и ключи.
* `FS-4xxx` — статика/ФС.
* `PLG-5xxx` — плагины/контракт.
* `SEC-6xxx` — политика безопасности (IP deny, auth, CORS).
* `ADM-7xxx` — управление (hot-reload, сигналы).
* `INT-9xxx` — внутренние сбои.

> Числа стабильны; новые коды добавляются без изменения существующих.

---

## Справочник кодов, маппинг и рекомендации

### Валидация (VLD-1xxx)

| Код         | HTTP | Сообщение             | Когда                           | Рекомендации оператору                                                             |
| ----------- | ---- | --------------------- | ------------------------------- | ---------------------------------------------------------------------------------- |
| AG-VLD-1001 | —    | Invalid config schema | Нарушена JSON Schema            | Запустить `anygate check -c`, исправить путь/тип, свериться с `CONFIG_SCHEMA.json` |
| AG-VLD-1002 | —    | DSL parse error       | Ошибка разбора строки маршрута  | Уточнить кавычки/формат: `"HEAD": "ACTION"`, проверить `DSL_SPEC.md`               |
| AG-VLD-1003 | —    | Route conflict        | Равнозначные правила            | Объединить/переупорядочить; оставить одно «победившее»                             |
| AG-VLD-1004 | —    | Invalid status/body   | Некорректный код/JSON в `fixed` | Исправить код, проверить JSON валидатором                                          |
| AG-VLD-1005 | —    | Static root invalid   | Путь к каталогу статики         | Указать существующий каталог; права `read/execute`                                 |
| AG-VLD-1006 | —    | TLS config invalid    | Несогласованные поля TLS        | Проверить пары `cert/key`, `client_ca`, `alpn`                                     |

> Эти ошибки **блокируют запуск/горячую загрузку**. Текущая конфигурация остаётся активной.

---

### Рантайм/приём HTTP (RTE-1yxz)

| Код         | HTTP | Сообщение          | Когда                                 | Рекомендации                                                          |
| ----------- | ---- | ------------------ | ------------------------------------- | --------------------------------------------------------------------- |
| AG-RTE-1101 | 400  | Bad request line   | Не удалось разобрать стартовую строку | Проверить клиента/балансер перед AnyGate                              |
| AG-RTE-1102 | 431  | Headers too large  | Заголовки превышают лимит             | Увеличить `read_buffer_size`/лимиты или исправить клиента             |
| AG-RTE-1103 | 413  | Body too large     | Тело больше `max_request_body_size`   | Увеличить лимит или корректировать клиента                            |
| AG-RTE-1104 | 408  | Request timeout    | Клиент медленно шлёт/читает           | Подстроить таймауты, включить rate/deny для подозрительных IP         |
| AG-RTE-1105 | 405  | Method not allowed | Путь есть, метод не подходит          | Проверить список методов в DSL; клиенту вернуть допустимые            |
| AG-RTE-1106 | 404  | Route not found    | Нет совпадений                        | Проверить DSL/приоритеты/префикс                                      |
| AG-RTE-1107 | 415  | Multipart disabled | `disable_multipart_form: true`        | Включить парсинг или менять клиент                                    |
| AG-RTE-1108 | 503  | Concurrency limit  | Достигнут лимит соединений            | Увеличить `concurrency`/ресурсы, включить `sleep_when_limit_exceeded` |

---

### Прокси/апстрим (UPS-2xxx)

| Код         | HTTP | Сообщение                 | Когда                         | Рекомендации                                                                             |
| ----------- | ---- | ------------------------- | ----------------------------- | ---------------------------------------------------------------------------------------- |
| AG-UPS-2001 | 502  | Upstream connect failed   | `ECONNREFUSED`, `ENETUNREACH` | Проверить апстрим/сеть/DNS; readiness                                                    |
| AG-UPS-2002 | 504  | Connect timeout           | Не установили TCP/TLS вовремя | Увеличить `connect_timeout`, проверить маршрут/ACL                                       |
| AG-UPS-2003 | 504  | Upstream read timeout     | Ответ не пришёл               | Увеличить `read_timeout`; профилировать апстрим                                          |
| AG-UPS-2004 | 502  | Upstream reset            | RST/stream reset              | Проверить логи апстрима, MTU/keep-alive                                                  |
| AG-UPS-2005 | 502  | TLS to upstream failed    | Валидация/рукопожатие         | Проверить цепочку `client → AnyGate → upstream`, `insecure_skip_verify` только для теста |
| AG-UPS-2006 | 503  | Circuit open              | Открылся брейкер              | Проверить здоровье апстрима, пороги брейкера, снять с трафика                            |
| AG-UPS-2007 | 502  | Invalid upstream response | Нарушение протокола           | Проверить ответ, версии h1/h2, заголовки                                                 |
| AG-UPS-2008 | 504  | Retry exhausted           | Все повторы исчерпаны         | Увеличить `retries`/джиттер, деградировать фичу                                          |

---

### TLS/вход (TLS-3xxx)

| Код         | HTTP | Сообщение                 | Когда                     | Рекомендации                                                  |
| ----------- | ---- | ------------------------- | ------------------------- | ------------------------------------------------------------- |
| AG-TLS-3001 | —    | Handshake failed          | Ошибка TLS на входе       | Проверить профиль, ключ/сертификат, совместимость клиента     |
| AG-TLS-3002 | —    | mTLS client cert required | Кл. сертификат обязателен | Убедиться, что клиент передаёт cert; выдать из доверенного CA |
| AG-TLS-3003 | —    | OCSP stapling error       | OCSP недоступен/невалиден | Проверить доступ к OCSP/кеш; при необходимости отключить      |

> Для TLS-сбоев HTTP-ответ может быть невозможен; ориентируйтесь на логи.

---

### Файловая система/статика (FS-4xxx)

| Код        | HTTP | Сообщение              | Когда                    | Рекомендации                                          |
| ---------- | ---- | ---------------------- | ------------------------ | ----------------------------------------------------- |
| AG-FS-4001 | 404  | File not found         | Файл отсутствует         | Проверить `root`, `index_names`, SPA-fallback         |
| AG-FS-4002 | 403  | Path traversal blocked | Попытка выхода за корень | Норма; при ложных срабатываниях проверить правила     |
| AG-FS-4003 | 416  | Range not satisfiable  | Некорректный Range       | Проверить запрос клиента, возвр. общую длину          |
| AG-FS-4004 | 500  | Compression failed     | Ошибка gzip/br/zstd      | В логах — причина; временно отключить компрессию      |
| AG-FS-4005 | 500  | Sendfile/mmap error    | Ошибка ФС/IO             | Проверить права/диск, переключиться на fallback режим |

---

### Плагины (PLG-5xxx)

| Код         | HTTP | Сообщение               | Когда                 | Рекомендации                                      |
| ----------- | ---- | ----------------------- | --------------------- | ------------------------------------------------- |
| AG-PLG-5001 | 429  | Rate limited            | Лимит достигнут       | Настроить лимиты/области; клиенту — `Retry-After` |
| AG-PLG-5002 | 500  | Plugin init failed      | Ошибка инициализации  | Проверить секцию `plugins`, конфиг                |
| AG-PLG-5003 | 500  | Plugin runtime error    | Сбой в `pre/post`     | Отключить плагин, открыть тикет, анализ логов     |
| AG-PLG-5004 | 400  | Header policy violation | Запрещённый заголовок | Исправить клиента/политику плагина `headers`      |

---

### Политики безопасности (SEC-6xxx)

| Код         | HTTP | Сообщение           | Когда                  | Рекомендации                                 |
| ----------- | ---- | ------------------- | ---------------------- | -------------------------------------------- |
| AG-SEC-6001 | 401  | Unauthorized        | Нет/неверный токен     | Проверить заголовок/секреты/часовой пояс     |
| AG-SEC-6002 | 403  | Forbidden           | Политика запретила     | Проверить IP allow/deny, auth-политику       |
| AG-SEC-6003 | 403  | CORS rejected       | Неверный origin/method | Сверить `cors`-настройки, ответ на preflight |
| AG-SEC-6004 | 400  | Invalid client cert | mTLS: нефин жем        | Проверить цепочку доверия и CN/SAN           |

---

### Управление/админ (ADM-7xxx)

| Код         | HTTP | Сообщение                    | Когда                        | Рекомендации                                  |
| ----------- | ---- | ---------------------------- | ---------------------------- | --------------------------------------------- |
| AG-ADM-7001 | —    | Hot-reload failed (kept old) | Новая конфигурация не прошла | Исправить и повторить; текущая версия активна |
| AG-ADM-7002 | —    | Graceful shutdown start      | Инициирован graceful         | Наблюдать метрики дренажа и сроки             |
| AG-ADM-7003 | —    | Signal received              | Получен сигнал ОС            | Проверить инициатора/автоматизацию            |

---

### Внутренние (INT-9xxx)

| Код         | HTTP | Сообщение            | Когда                         | Рекомендации                                           |
| ----------- | ---- | -------------------- | ----------------------------- | ------------------------------------------------------ |
| AG-INT-9001 | 500  | Internal error       | Неожиданное исключение        | Собрать логи по `trace_id`, открыть инцидент           |
| AG-INT-9002 | 500  | OOM protected        | Защитное завершение аллокации | Проверить лимиты памяти/пулы буферов                   |
| AG-INT-9003 | 503  | Backpressure applied | Система перегружена           | Увеличить ресурсы, включить лимитирование/отбрасывание |

---

## Заголовки и метаданные ответа

* `X-Request-Id` — корреляция запроса.
* `Retry-After` — при `429` и некоторых `503`.
* `Via`/`Server` — если включены.
* Никогда не возвращать внутренние коды/errno/пути ФС.

---

## Карта маппинга условий в статусы HTTP

| Условие                         | Статус                   |
| ------------------------------- | ------------------------ |
| Нет маршрута                    | `404 Not Found`          |
| Путь есть, метод не совпал      | `405 Method Not Allowed` |
| Заголовки/тело превышают лимиты | `431` / `413`            |
| Таймаут чтения клиента          | `408 Request Timeout`    |
| Политика запрещает              | `401/403`                |
| Rate-limit                      | `429 Too Many Requests`  |
| Ошибки апстрима                 | `502/504/503`            |
| Статика: не найдено/диапазон    | `404/416`                |
| Внутренняя ошибка               | `500`                    |

---

## Рекомендации оператору (быстрые плейбуки)

### Диагностика апстрима

* Сигнатуры: `AG-UPS-2001..2008`, рост `5xx` с кодами `502/504/503`.
* Действия: проверить readiness/liveness апстрима, DNS/маршрутизацию, сравнить квантиль `upstream_duration`.
* Метрики: `proxy_upstream_connect_errors_total`, `upstream_open_connections`, `retries_total`, `circuit_open`.

### Лимиты и таймауты

* Сигнатуры: `AG-RTE-1102/1103/1104/1108`, рост `408/431/413/503`.
* Действия: откорректировать `*_timeout`, `max_request_body_size`, `concurrency`; включить/усилить rate-limit.

### CORS/Auth/IP

* Сигнатуры: `AG-SEC-6001..6003`, рост `401/403` на единичных origin.
* Действия: сверить политику `cors`, аудит токенов/часов; проверить allow/deny маски.

### Статика/ФС

* Сигнатуры: `AG-FS-4001..4005`, всплеск `404/416/500`.
* Действия: целостность артефактов, наличие `index.html`, включить `spa_fallback`, проверить права и диск.

### Горячая замена/конфиг

* Сигнатура: `AG-ADM-7001`.
* Действия: `anygate check -c`, просмотреть позицию ошибки (строка/колонка), откат к предыдущему коммиту конфига.

---

## Требования к текстам сообщений

* Коротко, без жаргона и внутренних id.
* Английский по умолчанию в HTTP; локализация — только в документации.
* Не включать секреты, токены, пути ФС, внутренние IP за пределами диапазона `upstream` в логе при `secure_error_log: true`.

---

## Примеры

### Превышение размера тела

HTTP:

```json
{
  "error": {
    "code": "AG-RTE-1103",
    "message": "Request body too large",
    "status": 413
  },
  "trace": { "trace_id": "cafe8eed0b" }
}
```

Лог:

```json
{
  "ts":"2025-10-17T10:00:00Z","level":"WARN","code":"AG-RTE-1103",
  "message":"body exceeded limit","trace_id":"cafe8eed0b",
  "limit_bytes":1048576,"received_bytes":2097152,"route":"POST /upload"
}
```

### Отказ апстрима по таймауту

HTTP:

```json
{
  "error": {
    "code": "AG-UPS-2003",
    "message": "Gateway timeout: upstream did not respond",
    "status": 504
  },
  "trace": { "trace_id": "beef0001" }
}
```

### Запрет по IP

HTTP:

```json
{
  "error": {
    "code": "AG-SEC-6002",
    "message": "Forbidden by policy",
    "status": 403
  },
  "trace": { "trace_id": "deadbeef" }
}
```

---

## Тесты приёмки каталога

* Все коды присутствуют в реестре и недублируются.
* Линтер сообщений: `code` по шаблону `AG-[A-Z]{3}-\d{4}`, `message` не длиннее разумной границы, без секретов.
* Демонстрационные конфиги из `examples/` при ошибках формируют корректные коды согласно таблицам.
* Интеграционные тесты проверяют маппинг условий в HTTP-статусы и наличие `X-Request-Id`.

---

## Эволюция каталога

* Новые коды добавляются с пополнением таблиц и плейбуков.
* Изменение текста `message` допускается без изменения `code`.
* Удаление кодов не допускается; вместо этого — пометка `deprecated` с указанием замены.
