# STATUS_POLICY.md — Политика HTTP-кодов по сценариям

## Назначение

Установить предсказуемые и согласованные правила возврата статусов HTTP для AnyGate во всех подсистемах: маршрутизация, прокси, статика, плагины, CORS, echo/fixed, TLS и эксплуатационные состояния. Документ согласован с API/Frontend и обязателен для реализации и тестов.

---

## Принципы

* **Детерминизм:** одинаковые условия → одинаковый код.
* **Минимум сюрпризов:** следуем RFC и привычным практикам браузеров/клиентов.
* **Чёткая граница ответственности:** ошибки клиента → `4xx`, сбои апстрима/шлюза → `50x`, недоступность/дросселирование → `429/503`.
* **Сигнализация для клиента:** где уместно — заголовки `Allow`, `Retry-After`, `WWW-Authenticate`, `Location`, `ETag`, `Content-Range`.

---

## Матрица кодов по сценариям

### Успех

| Сценарий                   | Код                       | Примечания                                              |
| -------------------------- | ------------------------- | ------------------------------------------------------- |
| `fixed` без тела           | `200 OK`                  | Если не указан иной статус.                             |
| `fixed` с телом            | как задано                | Тип содержимого по телу (JSON/текст).                   |
| `echo`                     | `200 OK`                  | Если указан код — используем его.                       |
| `static` обычная выдача    | `200 OK`                  | `Cache-Control/ETag/Last-Modified` по политике статики. |
| `static` частичный контент | `206 Partial Content`     | При валидном `Range`.                                   |
| CORS preflight успешен     | `204 No Content`          | Только заголовки CORS.                                  |
| WebSocket upgrade          | `101 Switching Protocols` | При корректном `Upgrade`.                               |

### Перенаправления

| Сценарий             | Код                   | Примечания                                     |
| -------------------- | --------------------- | ---------------------------------------------- |
| `fixed` с редиректом | `301/302/303/307/308` | Требуется `Location`. Выбор кода — по конфигу. |

### Ошибки клиента

| Сценарий                                     | Код                                   | Заголовки/детали                            |
| -------------------------------------------- | ------------------------------------- | ------------------------------------------- |
| Неверная стартовая строка/запрос             | `400 Bad Request`                     | \                                           |
| Некорректные/запрещённые заголовки политикой | `400 Bad Request`                     | \                                           |
| Метод не разрешён для пути                   | `405 Method Not Allowed`              | `Allow` — перечень методов для этого пути.  |
| Маршрут не найден                            | `404 Not Found`                       | \                                           |
| `static`: файл не найден                     | `404 Not Found`                       | SPA-fallback может переопределить в `200`.  |
| Заголовки слишком большие                    | `431 Request Header Fields Too Large` | \                                           |
| Тело слишком большое                         | `413 Payload Too Large`               | \                                           |
| Таймаут чтения/записи клиентом               | `408 Request Timeout`                 | \                                           |
| Поддержка multipart отключена                | `415 Unsupported Media Type`          | \                                           |
| CORS: отклонённый origin/method/headers      | `403 Forbidden`                       | Preflight без соответствия — `403`.         |
| Отсутствует/неверный токен авторизации       | `401 Unauthorized`                    | Обязательно `WWW-Authenticate` по политике. |
| Политика IP deny                             | `403 Forbidden`                       | \                                           |
| `static`: неверный диапазон                  | `416 Range Not Satisfiable`           | `Content-Range: bytes */<len>`.             |
| Неподдерживаемая длина URI                   | `414 URI Too Long`                    | При местеем ограничений.                    |

### Ошибки шлюза/сервера

| Сценарий                                      | Код                         | Примечания                                                 |
| --------------------------------------------- | --------------------------- | ---------------------------------------------------------- |
| Апстрим: TCP отказ/сброс, протокольная ошибка | `502 Bad Gateway`           | Включая TLS-ошибки к апстриму.                             |
| Апстрим: таймауты подключения/чтения/записи   | `504 Gateway Timeout`       | Все виды таймаутов на пути к апстриму.                     |
| Circuit breaker открыт                        | `503 Service Unavailable`   | С `Retry-After`, если задано.                              |
| Перегрузка/лимит конкурентности               | `503 Service Unavailable`   | Может сопровождаться `Retry-After`.                        |
| Плановый graceful/дренаж                      | `503 Service Unavailable`   | \                                                          |
| Внутренняя ошибка                             | `500 Internal Server Error` | Не раскрывать детали.                                      |
| Не реализовано                                | `501 Not Implemented`       | Только для реально не поддержанных возможностей протокола. |

### Кэширование/условные запросы (статика)

| Сценарий                   | Код                | Заголовки                                    |
| -------------------------- | ------------------ | -------------------------------------------- |
| ETag/If-None-Match совпал  | `304 Not Modified` | `ETag`, опционально `Cache-Control`, `Vary`. |
| If-Modified-Since актуален | `304 Not Modified` | `Last-Modified`.                             |

---

## Политики заголовков по кодам

### Обязательно (если не отключено конфигом)

* `Date`, `Server` (если не задано `no_default_*`).
* `X-Request-Id` — корреляция для всех ответов.
* `Connection` — согласно keep-alive и состоянию graceful.

### Контекстно-зависимые

* `Allow` — при `405`.
* `WWW-Authenticate` — при `401`.
* `Location` — при `3xx`.
* `Retry-After` — при `429` и рекомендовано при `503` (число секунд или дата).
* `ETag`, `Last-Modified`, `Cache-Control`, `Vary`, `Accept-Ranges` — для статики.
* `Content-Range` — при `206/416`.
* `Via`/`Forwarded`/`X-Forwarded-*` — согласно настройкам прокси.

---

## Разрешение неоднозначностей

### Метод vs путь

* Если путь сматчен, но метод не входит в правило — `405` с `Allow`.
* Если ни один путь не сматчен — `404`, независимо от метода.

### SPA-fallback

* При включённом fallback, путь на файл не найден → отдаётся `index.html` со статусом `200` и корректными кэширующими заголовками (как настроено). Логи маркируют это как `spa_fallback=true`.

### Прокси таймауты и коннект-ошибки

* Любой таймаут на пути к апстриму → `504`.
* Немедленные сетевые/TLS ошибки, протокольные нарушения ответа → `502`.

### Лимитирование/перегрузка

* Плагин `rate-limiter` → `429` и `Retry-After`.
* Системная перегрузка/конкурентность/дренаж → `503`, опционально `Retry-After`.

### Echo/Fixed

* `echo` без статуса → `200`.
* `echo` со статусом → заданный код.
* `fixed` — строго заданный код; тело определяет `Content-Type`.

---

## Примеры DSL и ожидаемые статусы (YAML)

```yaml
routes:
  "/": "/dist/"                                   # GET / → 200; 304/206 по условиям
  "/ping": "http://localhost:8081/ping"           # upstream ok → 200; connect fail → 502; timeout → 504

  "GET POST PATCH /api/mock/rude": "FORBIDDEN {\"msg\":\"no\"}"
  # GET/POST/PATCH /api/mock/rude → 403; DELETE → 404 (нет такого правила)

  "GET /fastest/ever/ok": "OK"                    # → 200

  "/a/b/c": "*"                                   # echo → 200
  "/a/b/c-forbidden": "FORBIDDEN *"               # echo → 403

  "/files/*": "http://fs/"                        # прокси: таймаут → 504; reset → 502
  "/users/:id": "http://auth/users/"              # при  method mismatch → 405 с Allow
```

---

## Рекомендации для API/Frontend

### Коды для пользовательских операций

* Создание ресурса: отдавать `201 Created` через `fixed` или апстрим; при редиректе на локацию — `Location`.
* Идемпотентные GET/HEAD — ожидать `200/206/304`.
* Ошибки валидации тела/параметров на апстриме — `400`, не `422` (если иное не оговорено контрактом API).
* Ошибки авторизации — `401` (с `WWW-Authenticate`), запреты политики/прав — `403`.

### Поведение браузеров и SPA

* Всегда устанавливать `Vary: Accept-Encoding` при компрессии.
* Для SPA включить `spa_fallback` и корректный `Cache-Control` для HTML (обычно no-store/short), а для статических ассетов — длительный максимальный кеш с `ETag`/immutable.

---

## Соответствие с плагинами

### Auth

* Отсутствие/невалидный токен → `401` с `WWW-Authenticate`.
* Токен валиден, но недостаточно прав → `403`.

### Headers

* Запрещённые значения/заголовки клиента → `400` с деталью в логах.

### CORS

* Успешный preflight → `204`.
* Отклонённый preflight/кросс-запрос → `403`. В ответе только заголовки CORS-политики и краткое сообщение.

### IP allow/deny

* Совпадение deny → `403`. Для диагностик — логи с маской/правилом, без утечки внутренних сетей во внешние ответы.

---

## Эксплуатационные состояния

| Состояние                                    | Код                           | Политика                                     |
| -------------------------------------------- | ----------------------------- | -------------------------------------------- |
| Горячая замена конфига не применена (ошибка) | текущее поведение сохраняется | Ошибка в логах; внешние ответы не меняются.  |
| Начат graceful shutdown                      | `503 Service Unavailable`     | Для новых соединений; активные дренируются.  |
| Превышена конкурентность                     | `503`                         | По достижении предела; метрики backpressure. |

---

## Проверки и тесты приёмки

* Интеграционные тесты покрывают все строки из раздела примеров и матрицы.
* При `405` всегда присутствует `Allow`.
* При `429` и выбранных `503` присутствует `Retry-After`.
* `static` корректно обрабатывает `Range`, `If-None-Match`, `If-Modified-Since`.
* Прокси различает `502` против `504` по типу сбоя (немедленный vs таймаут).
* Echo/fixed строго уважают заданный статус.
* CORS preflight: `204` с правильными CORS-заголовками.

---

## Эволюция

* Изменение политики кодов допускается только через RFC с согласованием API/Frontend.
* Расширение набора экспонируемых заголовков сопровождается обновлением тестов и документации.
