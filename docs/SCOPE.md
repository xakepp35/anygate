# AnyGate — Границы продукта (in/out, anti-goals)

## Назначение документа

Зафиксировать чёткие границы AnyGate: что входит в продукт (in-scope), что исключено (out-of-scope), какие цели пресекаются (anti-goals), и как классифицируются спорные случаи. Документ служит контрактом между продуктом, платформой и командами внедрения.

---

## Определение продукта

AnyGate — единый бинарь уровня L7: reverse-proxy, сервер статики, фиксированные и echo-ответы, декларативный DSL «в одну строку», наблюдаемость, базовые плагины. Приоритет — минимализм горячего пути, предсказуемость, воспроизводимость. Лицензия — MIT.

---

## In-scope (входит)

### Ядро и протоколы

* Асинхронный сетевой рантайм с реактором на epoll и планировщиком воркеров.
* HTTP/1.1 и HTTP/2 на приёме и к апстриму; h2c; keep-alive, потоковые тела.
* TLS через rustls, ALPN, session cache, OCSP stapling; mTLS по маршрутам/группам.
* HTTP/Upgrade passthrough (включая WebSocket) — прозрачная прокладка.

### Маршрутизация и DSL

* Декларативные правила: методы, пути с `:param` и хвостовой `*`, действия proxy/static/fixed/echo.
* Предкомпиляция правил в компактный radix-trie; приоритет специфичности; атомарный hot-reload (RCU).
* Префиксные прокси-пути с корректной нормализацией целевых URI.

### Действия (Actions)

* Fixed: мгновенные ответы статусом с опциональным телом (JSON/текст).
* Echo: диагностический возврат метода/пути/заголовков/части тела, опциональный статус.
* Static: раздача файлов из каталога, index-имена, SPA-fallback, ETag/Last-Modified, Range, sendfile/mmap/writev, on-the-fly gzip/brotli/zstd, автоотдача precompressed.
* Proxy: пулы соединений к апстриму, h1/h2, X-Forwarded/Forwarded, перепись Host, балансировка RR/least-conn, retries для идемпотентных, circuit-breaker, passive/active health-checks.

### Плагины (встроенные)

* logger (структурные логи, маскирование секретов).
* rate-limiter (token/leaky; области ip/route/ip_route).
* headers (add/remove/set).
* CORS.
* IP allow/deny (маски/подсети).
* Простая авторизация по заголовку/токену.

### Наблюдаемость

* Логи в stdout/stderr (JSON/читаемый), трасс-идентификаторы.
* Метрики Prometheus per-route, пулы апстрима, кэши статики/компрессии.
* Трейсинг через OpenTelemetry (экспорт в стандартные бэкенды).

### Конфигурация и управление

* Конфиг-файлы YAML/JSON/TOML, env-override.
* Горячая перезагрузка по сигналу с атомарной заменой подготовленных структур.
* CLI: `serve`, `check`, `pack-spa`; печать дерева маршрутов и активных фильтров.

### Упаковка и эксплуатация

* Контейнер без дистрибутива, пользователь без привилегий.
* Работа под systemd/инициализаторами без специальных агентов.
* Документация, схемы конфигов, пресеты миграций и наблюдаемости.

---

## Out-of-scope (не входит)

### Сетевой и транспортный уровни вне L7

* L4-балансировка, DNAT/SNAT, ingress-контроллер как оператор Kubernetes, BGP/ECMP.
* DDoS-защита уровня сети/транспорта, rate-shaping на IP/подсети с учётом гео.

### CDN/кеширующие функции

* Глобальная репликация контента, edge-кеш с консистентностью, ESI/HTML-инклюды, origin shield.

### Полноценные API-шлюзы

* OAuth/OIDC-flows, внешние JWT-интроспекции/скользящие токены, квоты/лимиты со стораджем, API-ключи с биллингом, схема-валидация OpenAPI и трансформация payload на уровне схем.

### WAF/контент-инспекция

* L7-WAF с сигнатурами/ML, DLP/PII-сканирование, антивирус и sandbox файлов.

### Роутинг как сервис и распределённая конфигурация

* Хранилища конфигурации (consul/etcd), push-конфиг по сети, динамическое сервис-дискавери.
* Централизованная панель управления и multi-tenant RBAC.

### Универсальные вычисления на пути запроса

* Встраивание динамических языков/скриптов в hot-path, JIT/интерпретаторы общего назначения.
* Сложные трансформации тела (re-encoding, media-транскодинг).

### Долговременное хранение и персистентность

* Базы данных, KV-хранилища, долговременный кеш; хранение пользовательских данных.

### Операторы/оркестраторы

* Helm-операторы, CRD-контроллеры, автоскейлеры; специализированные интеграции с секрет-менеджерами.

---

## Conditional (по фичам/условиям)

* HTTP/3/QUIC — фича, по умолчанию выключена.
* io_uring — фича, альтернативный ввод-вывод; по умолчанию выключена.
* Совместимость с экосистемой tokio — фича, по умолчанию выключена.
* Динамические плагины (cdylib/WASM) — фича, не рекомендуются для горячего пути.
* gRPC passthrough и h2c — включается конфигом; трансформация gRPC-сообщений — вне зоны.
* Автоотдача precompressed ресурсов — включается конфигом при наличии артефактов.

---

## Спорные случаи — классификация

| Область                          | Статус       | Пояснение                                                         |
| -------------------------------- | ------------ | ----------------------------------------------------------------- |
| WebSocket/Upgrade passthrough    | In-scope     | Прозрачная прокладка без модификации payload                      |
| URL-rewrite простого вида        | In-scope     | Префиксы/суффиксы, нормализация путей, без рег-шаблонов на тело   |
| Регулярные выражения в маршрутах | Conditional  | Возможны для пути; в hot-path не рекомендуется, включается фичей  |
| Переписывание тела ответа        | Out-of-scope | Только заголовки/статус; трансформация тела не выполняется        |
| Service discovery по DNS         | In-scope     | Статический список upstream + DNS-резолв, без консул/etcd         |
| Active health-checks             | In-scope     | Пинги/статусы; сложные сценарии оркестрации — вне зоны            |
| Full WAF                         | Out-of-scope | Фильтры уровня заголовков есть; сигнатуры/ML нет                  |
| OAuth/OIDC                       | Out-of-scope | Только простая авторизация по заголовку                           |
| Квоты/счётчики с персистом       | Out-of-scope | Rate-limit без внешнего стораджа; распределённые квоты — вне зоны |
| Admin HTTP-API для live-конфига  | Out-of-scope | Управление через файл и сигнал; без удалённого конфига            |
| Распределённый кеш               | Out-of-scope | Точечные LRU для статики; кластера кешей нет                      |
| gRPC transcoding                 | Out-of-scope | Только passthrough на уровне HTTP/2                               |

---

## Anti-goals (что сознательно не делаем)

* Превращение в «швейцарский нож»: отсутствие тяжёлых слоёв абстракций, интерпретаторов и бизнес-логики в горячем пути.
* Замещение CDN, API-gateway классов продуктов и WAF.
* Управление инфраструктурой: масштабирование, автодискавери, централизованные панели.
* Долговременное хранение пользовательских данных и журналов сверх ротации.
* Явная зависимость от одной экосистемы рантаймов; продукт остаётся самодостаточным бинарём.

---

## Границы интеграций

### Клиенты (ingress)

* Браузеры, мобильные приложения, машинные клиенты HTTP.
* Поддержка TLS, H/1.1, H/2; H/3 — по фиче.

### Апстримы (egress)

* HTTP-сервисы с H/1.1/H/2, включая gRPC passthrough.
* Балансировка по списку узлов; DNS-резолв доступен; внешние реестры сервисов не используются.

### Платформа

* Kubernetes, systemd, контейнерные рантаймы — поддерживаются «как есть».
* Секреты и ключи — поставляются платформой; ротация ключей вне продукта (описана в гайдах).

### Наблюдаемость

* Метрики — HTTP endpoint для Prometheus; логи — stdout/stderr; трасс — OTLP/совместимые экспортёры.
* Алерты/дашборды — шаблоны поставляются, но системы мониторинга остаются внешними.

---

## Политики данных

* AnyGate не хранит пользовательские payload дольше необходимости обработки запроса.
* Логи — только технические; маскирование секретов обязательно; ретеншн — ответственностm платформы.
* Статика отдается из локального каталога/тома; AnyGate не выполняет синхронизацию/репликацию.

---

## Предпосылки и ограничения

* Файловая система доступна только для чтения каталога статики и конфигов.
* Запуск от непривилегированного пользователя; drop-privileges, chroot/static-root по конфигу.
* Без внешних агентов управления; единственный источник правды — локальный конфиг.
* Эффективность зависит от системных тюнингов (ulimit, sysctl); поставляются гайды и профили.

---

## Приёмка границ (валидаторы)

* Для каждого спорного запроса в бэклог: метка **scope:in**, **scope:out** или **scope:conditional** с ссылкой на этот документ.
* Любая новая фича обязана указать: влияние на hot-path, необходимость фича-флага, соответствие anti-goals.
* Изменение статуса спорного случая — только через RFC с обновлением разделов «Спорные случаи» и «Anti-goals».

---

## Глоссарий коротких терминов

* **Hot-path** — участки кода, задействованные при типовых запросах на критических путях.
* **Passthrough** — прозрачная прокладка соединения/протокола без модификации полезной нагрузки.
* **Precompressed** — заранее сжатые версии статических ресурсов, отдаваемые по согласованию с клиентом.
* **RCU** — техника атомарной замены структур данных без блокировки читателей.

---

## Финализация

Настоящий SCOPE фиксирует неизменяемое ядро AnyGate: минимализм, предсказуемость и воспроизводимость. Любое расширение проверяется на соответствие in/out/anti-goals и не нарушает границы продукта.
