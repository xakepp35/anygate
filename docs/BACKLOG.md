# AnyGate — Baccklog (Delivery Plan)

## Цели и результат

* [ ] MIT
* [ ] Единый бинарь (reverse-proxy + static + fixed + echo + плагины)
* [ ] Декларативный DSL «в одну строку»
* [ ] Производительность и предсказуемость горячих путей
* [ ] Минимальные зависимости
* [ ] Полный набор артефактов: код, тесты, бенчи, конфиги, контейнер, документы

## Профиль релиза

* [ ] Теги исходников
* [ ] Релизы для платформ
  * [ ] Linux
  * [ ] macOS
  * [ ] Windows
* [ ] Контейнер без дистрибутива (непривилегированный пользователь)
* [ ] Примеры конфигов
* [ ] Минимальный набор фич
  * [ ] DSL
  * [ ] Fixed
  * [ ] Echo
  * [ ] Static
    * [ ] sendfile
    * [ ] mmap
  * [ ] Proxy
    * [ ] h1
    * [ ] h2
  * [ ] Плагины: 
    * [ ] logger
    * [ ] rate
    * [ ] headers
    * [ ] cors
    * [ ] ip
    * [ ] auth
  * [ ] Метрики / логи / трейсинг
  * [ ] Hot-reload
  * [ ] TLS
  * [ ] Graceful shutdown

---

## Дорожная зависимость задач (высокоуровневый порядок)

**A → B → C → D → E → F → G → H → I → J → K → L → M → N → O → P**

---

## Этап A — Инициализация проекта

* [ ] Структура репозитория
  * [ ] `crates/runtime` — реактор, планировщик, таймеры, пулы буферов
  * [ ] `crates/http` — парсеры/кодеки h1/h2, абстракции коннекта
  * [ ] `crates/tls` — интеграция с rustls
  * [ ] `crates/router` — DSL, IR, trie, RCU
  * [ ] `crates/actions` — fixed, echo, static, proxy
  * [ ] `crates/plugins` — контракт Filter, встроенные плагины
  * [ ] `crates/obs` — логи, метрики, трейсинг
  * [ ] `crates/config` — модели, валидация, загрузка, env-override
  * [ ] `bin/anygate` — CLI и точка входа
  * [ ] `bench/` — нагрузочные стенды и скрипты
  * [ ] `docs/` — спецификации и гайды
  * [ ] `deploy/` — контейнер, оркестраторы
  * [ ] `examples/` — минимальные конфиги и SPA

* [ ] Политика качества
  * [ ] Фиксированная toolchain
  * [ ] Линт/формат, `deny` опасных фич
  * [ ] Политика `unsafe`: локализация, ревью, тест-контуры
  * [ ] Лицензии зависимостей: контроль и отчет

---

## Этап B — Runtime ядра

* [ ] Реактор на epoll
  * [ ] Регистрация/дерегистрация сокетов
  * [ ] Edge-triggered уведомления
  * [ ] Таймауты и будильники событий
  * [ ] Очередь событий, backpressure на чтение/запись

* [ ] Планировщик
  * [ ] Воркеры, work-stealing, pinning
  * [ ] Парковка/разморозка потоков
  * [ ] Таймер-колесо, отмена таймеров

* [ ] Пулы буферов
  * [ ] Аренный аллокатор сетевых буферов
  * [ ] Пулы для компрессии и кодеков HTTP

* [ ] Совместимость
  * [ ] Фича совместимости с tokio (выключена по умолчанию)
  * [ ] Адаптеры для режима совместимости

---

## Этап C — Стек HTTP и TLS

* [ ] HTTP классический
  * [ ] Разбор стартовой строки и заголовков
  * [ ] Chunked, streaming тела
  * [ ] Лимиты на заголовки и тело
  * [ ] Защита от slow-loris

* [ ] HTTP с мультиплексированием
  * [ ] Управление потоками и окнами
  * [ ] Приоритеты
  * [ ] h2c и TLS-вариант

* [ ] TLS
  * [ ] rustls
  * [ ] ALPN
  * [ ] session cache
  * [ ] OCSP stapling
  * [ ] Профили шифросютов
  * [ ] mTLS per-route/group

---

## Этап D — Конфиг, DSL, Router

* [ ] Модель конфигурации
  * [ ] YAML
  * [ ] JSON
  * [ ] TOML
  * [ ] Env-override
  * [ ] Проверки целостности
  * [ ] Секции:
    * [ ] `server`
    * [ ] `tls`
    * [ ] `proxy`
    * [ ] `static`
    * [ ] `plugins`
    * [ ] `groups`
    * [ ] `routes`

* [ ] DSL
  * [ ] Лексер/парсер на байтах (без лишних аллокаций)
  * [ ] Методы, пути (`:param`, `*`), действия proxy/static/fixed/echo
  * [ ] Словарные статусы и трёхзначные коды
  * [ ] Подсветка ошибок: строка, позиция, причина

* [ ] IR и trie
  * [ ] Нормализация префиксов, предкомпиляция правил
  * [ ] Radix-trie по сегментам, битмаска методов
  * [ ] Приоритет специфичности
  * [ ] Контейнер RCU для атомарного обновления

* [ ] Выбор маршрута
  * [ ] Метод → точное → параметр → `*` → порядок декларации
  * [ ] Передача `:param` и `splat` в контекст действий/фильтров

---

## Этап E — Действия Fixed и Echo

* [ ] Fixed
  * [ ] Предсобранные ответы: статус, опциональное тело
  * [ ] Авто Content-Type (JSON/текст)
  * [ ] Переопределение заголовков конфигом

* [ ] Echo
  * [ ] Метод, путь, заголовки, первые байты тела (лимит)
  * [ ] Опциональный статус

---

## Этап F — Static

* [ ] Разрешение пути
  * [ ] Нормализация и защита от выхода за корень
  * [ ] Index-имена
  * [ ] SPA-fallback

* [ ] Отдача
  * [ ] sendfile для прямых сокетов
  * [ ] mmap для мелких файлов
  * [ ] writev для склейки заголовков/тела

* [ ] Кеширование и условные запросы
  * [ ] ETag слабый/сильный
  * [ ] Last-Modified
  * [ ] If-None-Match / If-Modified-Since

* [ ] Диапазоны
  * [ ] Single-range
  * [ ] Multi-range

* [ ] Компрессия
  * [ ] gzip
  * [ ] brotli
  * [ ] zstd
  * [ ] с пулами
  * [ ] Автоотдача предварительно сжатых ресурсов

---

## Этап G — Proxy

* [ ] Клиент соединений
  * [ ] Неблокирующие сокеты, keep-alive
  * [ ] Лимиты, пулы на апстрим
  * [ ] h1/h2, выбор на основе ALPN/конфига

* [ ] Заголовки и переписывание
  * [ ] X-Forwarded-For/Proto/Host
  * [ ] Forwarded
  * [ ] Перезапись Host

* [ ] Балансировка
  * [ ] Round-robin
  * [ ] Наименьшее число активных соединений

* [ ] Надёжность
  * [ ] Повторы для идемпотентных методов (с джиттером)
  * [ ] Circuit-breaker
  * [ ] Пассивные/активные health-checks

* [ ] Таймауты
  * [ ] Подключение
  * [ ] Чтение
  * [ ] Запись
  * [ ] Общая длительность

---

## Этап H — Плагины

* [ ] Контракт Filter
  * [ ] `pre` с возможностью короткого замыкания
  * [ ] `post`
  * [ ] Сериализуемые конфиги, статические варианты enum

* [ ] Встроенные фильтры
  * [ ] logger (структурные логи, маскирование секретов)
  * [ ] rate limiter (token/leaky; области ip/route/ip_route)
  * [ ] headers (add/remove/set; запрет опасных заголовков)
  * [ ] cors (источники, методы, заголовки, preflight)
  * [ ] ip allow/deny (маски/подсети)
  * [ ] auth (заголовок/токен, интеграция с внешним провайдером)

* [ ] Динамика (фича)
  * [ ] cdylib/WASM (выключено по умолчанию, вне hot path)

---

## Этап I — Наблюдаемость и управление

* [ ] Логи
  * [ ] JSON и человекочитаемый формат
  * [ ] Трасс-идентификаторы
  * [ ] Уровни логирования per-route

* [ ] Метрики
  * [ ] Счётчики кодов и RPS
  * [ ] Гистограммы задержек per-route
  * [ ] Состояние пулов апстрима
  * [ ] Кэши статики и компрессии

* [ ] Трейсинг
  * [ ] OpenTelemetry, экспорт в совместимые бекенды

* [ ] Управление
  * [ ] Горячая перезагрузка по сигналу
  * [ ] Атомарный swap конфига (RCU)
  * [ ] Graceful shutdown с дренажом keep-alive

---

## Этап J — Безопасность и изоляция

* [ ] Процесс
  * [ ] Смена пользователя/группы
  * [ ] chroot/static-root

* [ ] Валидация
  * [ ] Нормализация путей
  * [ ] Лимиты заголовков/тел
  * [ ] Защита от медленных клиентов

* [ ] Политики
  * [ ] TLS/mTLS пресеты
  * [ ] Профили шифросютов
  * [ ] HSTS (опционально)

---

## Этап K — CLI и UX разработчика

* [ ] Команды
  * [ ] `serve -c`
  * [ ] `check -c`
  * [ ] `pack-spa --from --to`

* [ ] Диагностика
  * [ ] Печать дерева роутинга
  * [ ] Список активных плагинов

* [ ] Сообщения об ошибках
  * [ ] Позиции в DSL (строка/колонка)
  * [ ] Диагностика конфликтов правил и пересечений

---

## Этап L — Бенчи и методика

* [ ] Сценарии
  * [ ] Fixed без тела
  * [ ] Static малый файл (кеш ОС)
  * [ ] Proxy passthrough без тела
  * [ ] Upload/download большого тела

* [ ] Стенд
  * [ ] Сетевой тюнинг (sysctl, ulimit)
  * [ ] Pinning прерываний/потоков
  * [ ] Повторяемые серии, отчёты в `bench/reports/`

* [ ] Верификация
  * [ ] Сравнение с эталонами на идентичном стенде
  * [ ] Тренды квантилей задержек и пропускной способности

---

## Этап M — Тестирование

* [ ] Unit
  * [ ] DSL
  * [ ] Trie-матчинг
  * [ ] Плагины
  * [ ] ETag/Range/Index
  * [ ] Заголовки X-Forwarded/Forwarded
  * [ ] Лимиты и таймауты

* [ ] Property-based
  * [ ] Генерация путей/методов/заголовков
  * [ ] Инварианты роутера и парсера

* [ ] Fuzz
  * [ ] h1 заголовки/стартовые строки
  * [ ] Кодировки, chunked, границы тела

* [ ] Integration
  * [ ] Все действия и плагины
  * [ ] TLS/mTLS
  * [ ] Hot-reload
  * [ ] Graceful
  * [ ] Ошибки апстрима

* [ ] Soak
  * [ ] Длительные серии
  * [ ] Мониторинг RSS/FD/ошибок

---

## Этап N — Документация

* [ ] `README.md` — обзор, быстрый старт
* [ ] `CONFIG.md` — секции и параметры
* [ ] `ROUTES.md` — грамматика DSL, примеры, приоритеты
* [ ] `PLUGINS.md` — контракт, встроенные фильтры, конфиги
* [ ] `BENCH.md` — методика, сценарии воспроизведения
* [ ] `TUNING.md` — сетевые/системные пресеты
* [ ] `SECURITY.md` — TLS/mTLS, изоляция процесса
* [ ] `MIGRATION.md` — переход с nginx/traefik/HAProxy, эквиваленты правил

---

## Этап O — Поставка

* [ ] Контейнер
  * [ ] FROM + Многоступенчатая сборка
  * [ ] Финальный слой без дистрибутива
  * [ ] Пользователь без привилегий
  * [ ] Пример запуска с `anygate.yml` и каталогом статики

* [ ] Дистрибутивы
  * [ ] Сборки для целевых платформ
  * [ ] Подписи и хэши

* [ ] Оркестраторы
  * [ ] Манифесты запуска
  * [ ] Переменные окружения
  * [ ] Readiness/Liveness пробы

* [ ] Примеры
  * [ ] SPA с правилом `"/": "/dist/"`
  * [ ] Прокси на локальный echo-бэкенд
  * [ ] Примеры fixed/echo

---

## Этап P — Релиз

* [ ] Freeze
  * [ ] Заморозка API/DSL
  * [ ] Метки совместимости
  * [ ] Известные ограничения

* [ ] Чек-лист качества
  * [ ] Полный прогон тестов
  * [ ] Стабильный hot-reload
  * [ ] Отсутствие регрессий

* [ ] Релиз-ноты
  * [ ] Ключевые возможности
  * [ ] Инструкции обновления
  * [ ] Оговорки

* [ ] Анонс
  * [ ] Документ для внедрения в команды
  * [ ] Пресеты, примеры конфигов, гайды

---

## Артефакты / DoR (критерии готовности)

* [ ] Ядро
  * [ ] Реактор, планировщик, таймеры, пулы — устойчивы под длительной нагрузкой
  * [ ] Нет утечек, предсказуемые аллокации, контроль `unsafe`

* [ ] Протоколы
  * [ ] h1/h2 приём и апстрим
  * [ ] Корректные keep-alive и границы тел
  * [ ] TLS/mTLS, ALPN, OCSP stapling

* [ ] Роутинг и DSL
  * [ ] Парсер устойчив к мусору
  * [ ] Понятные ошибки с позициями
  * [ ] Property/fuzz покрытие
  * [ ] Trie корректно разрешает приоритеты
  * [ ] RCU-обновление атомарно

* [ ] Действия
  * [ ] Fixed/Echo — без аллокаций в hot path
  * [ ] Static — sendfile/mmap/writev, ETag/Range/Index/SPA, компрессия
  * [ ] Proxy — пулы, балансировка, retries, circuit-breaker, Forwarded

* [ ] Плагины
  * [ ] logger/rate/headers/cors/ip/auth — без деградации при отключении
  * [ ] Контракт Filter стабилен, конфиги валидируются

* [ ] Наблюдаемость
  * [ ] Метрики per-route, пулов, кэшей
  * [ ] Логи с трасс-идентификаторами
  * [ ] Экспорт трейсов

* [ ] UX и CLI
  * [ ] Валидация конфигов и DSL с указанием строк/причин
  * [ ] Диагностика дерева правил и плагинов

* [ ] Безопасность и изоляция
  * [ ] Пользователь без привилегий, chroot/static-root
  * [ ] Политики TLS
  * [ ] Лимиты тел/заголовков

* [ ] Производительность
  * [ ] Стабильность верхних квантилей по бенчам
  * [ ] Подтверждённый профиль против эталонов

---

## Пресеты для быстрого старта
* [ ] Минимальный `config.yml` с `"/": "/dist/"`, echo и fixed-примером
* [ ] Пресет проксирования на внутренний сервис с X-Forwarded и балансировкой

---

## Acceptance сценарии «клятвы» заказчику
* [ ] `"/": "/dist/"` — SPA с index и history-fallback
* [ ] `"/ping": "http://auth/ping"` — прокси с корректными заголовками
* [ ] `GET POST PATCH /api/mock/rude: FORBIDDEN {"msg":"GO PATCH UR MUM!"}` — фиксированный ответ с JSON
* [ ] `GET /fastest/ever/ok: OK` — мгновенный ответ
* [ ] `/a/b/c: *` — echo
* [ ] `/a/b/c-forbidden: FORBIDDEN *` — echo со статусом

---

## Риски и планы смягчения
* [ ] Сложность h2 и мультиплексирования → изоляция кодеков в `crates/http`, расширенные тесты
* [ ] Разброс производительности на разных ядрах → стандартные профили тюнинга, фиксирование стенда
* [ ] Рост матрицы платформ → минимальные цели в релизе, расширение по мере стабилизации

---

## Пострелизные направления
* [ ] HTTP поверх QUIC (фича)
* [ ] io_uring как альтернативный ввод-вывод (фича)
* [ ] Расширенная политика кэширования статики и precompressed манифесты
* [ ] Расширение набора фильтров и интеграций наблюдаемости
