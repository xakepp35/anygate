# DSL_SPEC.md — Формальная спецификация DSL маршрутизации

## Назначение

Однозначный синтаксис и семантика DSL AnyGate для описания маршрутов: лексика, грамматика, приоритеты матчинга, нормализация и приёмочные примеры. Спецификация учитывает, что методы не ограничены фиксированным списком и допускают произвольные токены метода.

---

## Модель представления в конфиге

В разделе `routes` конфигурации используется **YAML-отображение**:

```
routes:
  "<HEAD>": "<ACTION>"
```

* **HEAD** — «голова» правила: `[МЕТОДЫ ]ПУТЬ`
* **ACTION** — действие: `proxy | static | fixed | echo` (см. ниже)

Рекомендации по кавычкам:

* Ключ `HEAD` почти всегда содержит пробелы ⇒ **всегда** берём в кавычки.
* Значение `ACTION` также берём в кавычки, особенно если есть `*`, JSON или двоеточия.

---

## Лексика

### Токены метода

* `METHOD` — **любой корректный HTTP-токен метода** (по синтаксису token), либо специальный символ `*` (все методы).
* Список методов **не ограничен** (пример: `GET`, `POST`, `PROPFIND`, `SEARCH`, `RPC` и т. п.).
* Сопоставление метода — **регистрозависимое** (строгое совпадение байтов).
* Если методы в `HEAD` **опущены**, это эквивалентно `*` (все методы).
* Если в списке методов присутствует `*`, остальные методы игнорируются.

### Путь

* Абсолютный путь `/…` из сегментов, разделённых `/`.
* Сегмент:
  — `literal` — произвольная непустая последовательность символов без `/` (URL-декодирование не выполняется при сравнении);
  — `:param` — параметр сегмента, имя `ident`;
  — хвостовая маска `*` — **только последним сегментом** и не более одного раза во всём пути.

### Прочие лексемы

* `STATUS` — трёхзначный код `100–599` либо одно из ключевых слов статусов (см. раздел «Статусы»).
* `URI` — абсолютный `http://…` или `https://…` для `proxy`.
* `DIR` — путь к каталогу статики (абсолютный или относительный).
* `JSON` — корректный JSON (RFC 8259).
* `TEXT` — произвольный текст до конца строки значения YAML.

---

## Грамматика (EBNF)

### Голова правила (ключ YAML)

```
head        = [ methods , SP ] , path ;

methods     = method , { SP , method } ;
method      = "*" | token ;
token       = 1*( tchar ) ;
tchar       = ALPHA | DIGIT | "!" | "#" | "$" | "%" | "&" | "'" | "*"
            | "+" | "-" | "." | "^" | "_" | "`" | "|" | "~" ;

path        = "/" , { segment } ;
segment     = literal | param | splat ;
literal     = 1*( VCHAR - "/" ) , [ "/" ] ;
param       = ":" , ident , "/" ;
splat       = "*" ;                          (* только в хвосте пути, без завершающего "/" *)
ident       = ALPHA , { ALPHA | DIGIT | "_" | "-" } ;

SP          = 1*( " " | "\t" ) ;
```

**Правила для `splat`:**

* может встречаться **только один раз** и **только последним сегментом** пути (то есть `…/*` без завершающего `/`).

### Действие (значение YAML)

```
action        = proxy_action | static_action | fixed_action | echo_action ;

proxy_action  = uri ;
static_action = dir ;
fixed_action  = status , [ SP , body ] ;
echo_action   = "*" | ( status , SP , "*" ) ;

status        = 3DIGITS | status_ident ;
status_ident  = "OK" | "CREATED" | "ACCEPTED" | "NO_CONTENT" | "MOVED" | "FOUND"
              | "SEE_OTHER" | "NOT_MODIFIED" | "TEMP_REDIRECT" | "PERM_REDIRECT"
              | "BAD_REQUEST" | "UNAUTHORIZED" | "FORBIDDEN" | "NOT_FOUND"
              | "METHOD_NOT_ALLOWED" | "CONFLICT" | "GONE" | "TOO_MANY_REQUESTS"
              | "INTERNAL_ERROR" | "NOT_IMPLEMENTED" | "BAD_GATEWAY"
              | "SERVICE_UNAVAILABLE" | "GATEWAY_TIMEOUT" ;

body          = json | text ;
json          = JSON ;                        (* строгая проверка синтаксиса *)
text          = 1*( ANY_CHAR_EXCEPT_NEWLINE ) ;

uri           = "http://"  , URI_REST
              | "https://" , URI_REST ;
dir           = "/" , FILEPATH_REST | "." , FILEPATH_REST ;
```

---

## Семантика

### Методы

* `[методы]` в `HEAD` — список через пробел, например:
  `"GET POST /x/y"` или `"PROPFIND SEARCH /dav/*"`.
* Отсутствие методов эквивалентно `*` (все методы).
* Наличие `*` в списке перекрывает любые перечисленные методы.

### Параметры пути

* `:param` извлекает один сегмент (без `/`), сохраняется как `params.<имя>`.
* `*` собирает остаток пути в `params.splat` (может быть пустым).

### `proxy`

* Проксирует на `URI`. Если `path` в `HEAD` заканчивается `/`, хвост запрошенного пути, идущий **после** этого префикса, конкатенируется к `URI` без двойных слэшей.

### `static`

* Раздаёт файлы из каталога `DIR`. Index-имена и SPA-fallback настраиваются сервером. Безопасная нормализация пути (выход за корень запрещён).

### `fixed`

* Немедленный ответ указанным `STATUS`. Если `body` — корректный JSON, `Content-Type` = `application/json; charset=utf-8`, иначе `text/plain; charset=utf-8`.

### `echo`

* Ответ для диагностики: метод, путь, заголовки, первые байты тела (порог конфигурируется).
* Вариант с кодом: `"FORBIDDEN *"` и др.

---

## Приоритеты матчинга (детерминизм)

Порядок выбора правила:

###

Метод: точное совпадение метода имеет приоритет над `*`.

###

Специфичность пути:

* больше сегментов предпочтительнее;
* среди одинаковой длины: больше литералов → выше приоритет;
* `literal` ≻ `:param` ≻ `splat`.

###

Порядок объявления: полные равнозначности разрешаются порядком в конфиге сверху вниз.

---

## Нормализация

* Сравнение выполняется по байтам без URL-декодирования.
* Удаление повторных `/` в пути **не** выполняется автоматически.
* Валидация пути и недопустимых последовательностей выполняется на этапе загрузки конфига.

---

## Ошибки и диагностика

Конфиг отвергается, если:

* в `head` `splat` не в хвосте или встречается более одного раза;
* `param` с пустым именем (`:/`) или некорректным `ident`;
* `status` не трёхзначный код и не из словаря;
* `proxy_action` содержит некорректный `URI`;
* `static_action` указывает не на каталог (при включённой проверке путей);
* `JSON` в `fixed` некорректен.

Валидатор возвращает строку и позицию (для ключа и значения отдельно) и человекочитаемую причину.

---

## Примеры YAML (корректные)

### Базовые

```yaml
routes:
  "/": "/dist/"
  "/ping": "http://localhost:8081/ping"
```

### Много методов + fixed c JSON

```yaml
routes:
  "GET POST PATCH /api/mock/rude": "FORBIDDEN {\"msg\":\"GO PATCH UR MUM!\"}"
```

### Мгновенный `OK`

```yaml
routes:
  "GET /fastest/ever/ok": "OK"
```

### Echo и echo со статусом

```yaml
routes:
  "/a/b/c": "*"
  "/a/b/c-forbidden": "FORBIDDEN *"
```

### Параметры и хвостовая маска

```yaml
routes:
  "/users/:id": "http://up/users/"
  "/files/*": "http://fs/"
```

### Префиксная прокси-директория

```yaml
routes:
  "/v1/": "http://up:9000/"
```

---

## Приёмочные сценарии (однозначность)

###

```
"GET /path": "OK"
"* /path": "FORBIDDEN"
```

* `GET /path` → первое правило (точный метод побеждает `*`)
* `POST /path` → второе правило

###

```
"/api/items": "http://a"
"/api/:res":  "http://b"
"/api/*":     "http://c"
```

* `/api/items` → `http://a`
* `/api/orders` → `http://b`
* `/api/anything/here` → `http://c`

###

```
"/v1/": "http://up:9000/"
```

* `/v1` → `http://up:9000/`
* `/v1/a/b` → `http://up:9000/a/b`

###

```
"PROPFIND SEARCH /dav/*": "OK"
```

* `PROPFIND /dav/x` → `OK`
* `SEARCH /dav/x/y` → `OK`
* `GET /dav/x` → не матчится

---

## Нетривиальные случаи

### Текст с двоеточиями в `fixed`

```yaml
routes:
  "POST /info": "200 key: value:more"
```

Тело — `TEXT` целиком: `key: value:more`.

### Явный JSON

```yaml
routes:
  "POST /echo-json": "OK {\"a\":1,\"b\":[2,3]}"
```

### Ошибки

```yaml
routes:
  "/bad/*/path": "OK"     # ошибка: * не в хвосте
  "/dup/:/x": "OK"        # ошибка: пустое имя параметра
  "FOO /x": ""            # ошибка: пустое действие
```

---

## Эволюция и расширения

* Расширения синтаксиса (например, регулярные выражения в сегментах) — фича-флаг, по умолчанию выключено. При включении приоритет: `literal` ≻ `regex` ≻ `param` ≻ `splat`.
* Изменения грамматики/приоритета — только через RFC и мажорное обновление.

---

## Критерии приёмки

* Любая корректная пара `"<HEAD>": "<ACTION>"` парсится **единственным образом**.
* Все примеры из раздела «Примеры YAML» проходят автотесты.
* Валидатор точно указывает место ошибки для ключа и значения.
* Отсутствие ограничений на набор методов подтверждено тестами (произвольные токены метода и `*`).
